# 한글 처리 개선 - 테스트 가이드

## 개선 내용

### 1. 순수 AutoLISP 기반 Unicode 디코더 구현
- VL- 함수 없이 16진수 변환 및 Unicode escape 처리
- CADian 및 구버전 AutoCAD 완벽 호환
- 블록 내 한글 텍스트 완벽 지원

### 2. 지원하는 Unicode 패턴
- `\U+XXXX`: 표준 Unicode escape (예: `\U+D55C` → 한)
- `\M+nXXXX`: MIF 인코딩 (일부 구버전 CAD)
- 직접 UTF-8 문자열

### 3. 상세한 디버그 로깅
- DXF 원본 데이터 기록
- 각 변환 단계별 결과 추적
- 블록 정의 및 속성 텍스트 추출 과정 로깅

## 테스트 방법

### 1단계: 파일 로드
```
1. AutoCAD/CADian 실행
2. dxfsplit_ver03.lsp 파일을 도면 창에 드래그 앤 드롭
   또는 APPLOAD 명령 사용
3. "Pure AutoLISP DWG Split loaded!" 메시지 확인
```

### 2단계: 테스트 도면 준비
```
다음과 같은 요소가 포함된 테스트 도면 준비:
- 한글이 포함된 TEXT 엔티티
- 한글이 포함된 MTEXT 엔티티
- 한글 속성을 가진 BLOCK (ATTDEF/ATTRIB)
- 각 요소를 포함하는 닫힌 POLYLINE (사각형)
```

### 3단계: 명령 실행
```
1. 명령창에 DDDD 또는 DXFRECT 입력
2. "Select closed polylines..." 메시지 확인
3. 닫힌 폴리라인 선택
4. Enter 키로 선택 완료
```

### 4단계: 결과 확인

#### 파일 생성 확인
```
현재 도면 폴더 → [도면명] 폴더 → 생성된 DWG 파일들 확인
파일명이 한글로 정상 생성되었는지 확인
```

#### 디버그 로그 확인
```
현재 도면 폴더 → console.log 파일 열기

확인 사항:
1. "=== TEXT/ATTRIB/ATTDEF 엔티티 텍스트 추출 ===" 섹션
   - DXF(1) 원본: Unicode escape 형태 확인 (예: \U+D55C\U+AE00)
   - Par-breaks 처리 후: 변환 중간 단계
   - Normalize 후: 최종 한글 텍스트

2. "=== MTEXT 엔티티 텍스트 추출 ===" 섹션
   - DXF(1) 원본 및 DXF(3) 조각들 확인
   - 병합 및 변환 과정 확인

3. "=== 블록 정의 텍스트 추출 ===" 섹션
   - 블록명 확인
   - 블록 내 텍스트 엔티티 개수
   - 각 엔티티의 변환 과정
```

## 예상 결과

### 성공 케이스
```
입력: 폴리라인 내 TEXT "한글테스트"
DXF 원본: \U+D55C\U+AE00\U+D14C\U+C2A4\U+D2B8
변환 결과: 한글테스트
파일명: 한글테스트.dwg
```

### 블록 속성 성공 케이스
```
입력: 폴리라인 내 BLOCK, 속성값 "A동"
블록 정의 찾음
DXF 원본: \U+0041\U+B3D9
변환 결과: A동
파일명: A동.dwg
```

## 문제 해결

### 한글이 여전히 ''으로 표시되는 경우

1. **console.log 확인**
   ```
   DXF(1) 원본이 어떤 형태인지 확인:
   - Unicode escape인가? (\U+XXXX)
   - MIF 인코딩인가? (\M+nXXXX)
   - 다른 형태의 인코딩인가?
   ```

2. **DXF 원본 패턴 확인**
   ```
   만약 새로운 패턴이 발견되면:
   - console.log의 해당 부분을 개발자에게 제공
   - decode-unicode-escapes 함수에 새 패턴 추가 필요
   ```

3. **AutoCAD/CADian 버전 확인**
   ```
   일부 매우 오래된 버전은 다른 인코딩을 사용할 수 있음
   버전 정보와 함께 문제 보고
   ```

### 파일명이 깨지는 경우

1. **PowerShell 인코딩 확인**
   ```
   Windows 시스템 언어가 한국어로 설정되어 있는지 확인
   PowerShell에서 UTF-8 지원 확인
   ```

2. **파일 시스템 확인**
   ```
   NTFS 파일 시스템 사용 확인
   FAT32는 한글 파일명에 제한이 있을 수 있음
   ```

## 디버그 로그 예시

```
=== TEXT 엔티티 텍스트 추출 ===
DXF(1) 원본: \U+D55C\U+AE00
Par-breaks 처리 후: \U+D55C\U+AE00
Normalize 후: 한글

=== 블록 정의 텍스트 추출: TITLE_BLOCK ===
블록 정의 찾음
블록 내 ATTDEF 엔티티 #1
=== ATTDEF 엔티티 텍스트 추출 ===
DXF(1) 원본: \U+C81C\U+BAA9
Par-breaks 처리 후: \U+C81C\U+BAA9
Normalize 후: 제목
블록 내 총 텍스트 엔티티: 1

SAFE=제목
DISPLAY=제목
RAW=\U+C81C\U+BAA9
Saved: C:\drawings\test\제목.dwg
```

## 추가 개선 사항

### 현재 구현된 기능
- ✅ Unicode escape (\U+XXXX) 디코딩
- ✅ MIF 인코딩 (\M+nXXXX) 기본 지원
- ✅ 블록 정의 텍스트 추출
- ✅ 블록 속성 텍스트 추출
- ✅ 상세 디버그 로깅
- ✅ PowerShell을 통한 Unicode 파일명 생성

### 향후 지원 가능 기능
- 더 많은 인코딩 패턴 추가 (사용자 피드백 기반)
- 텍스트 인코딩 자동 감지
- 다국어 지원 확장 (일본어, 중국어 등)

## 피드백

문제가 발생하거나 새로운 인코딩 패턴이 발견되면:
1. console.log 파일 전체 내용 제공
2. AutoCAD/CADian 버전 정보
3. 문제가 발생한 텍스트의 스크린샷
4. 가능하면 테스트 도면 파일 제공
